# Pure JDBC

- DAO 안에 Java 코드와 SQL 코드가 공존한다.
- 파일 관리가 어려워질 수 있다.
    
    → 실무에서 이런 식으로 프로그래밍 하지 않는다.
    
    → 별도의 library, framework를 쓴다.
    
    - MyBatis
        
        주로 복잡한 쿼리에 이용 (수학, 통계)
        
    - ORM (Object Relation Mapping)
        
        DB의 table을 class에 매핑시킨다.
        
        복잡한 쿼리는 적합하지 않다.
        

# MyBatis

- SQL 구문과 Java code를 분리
    
    쿼리를 변경해도 java코드를 따로 컴파일을 다시 안해도 된다.
    
- SQL의 실행 결과를 Map에 매핑시킨다.
- Data Source 기능 제공
    
    프로그램이 필요할 때 마다 DB에 연결하는 방식은 비효율적
    
    → connecting pool을 DB에 미리 많이 연결을 해 놓고 프로그램이 필요할 때 connection pool에 요청해서 빠르게 진행
    
- Transaction 기능 제공

## 설정 파일

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration 
        PUBLIC "-//mybatis.org/DTD Config 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-config.dtd" >
```

→ sqlMapConfig.xml 파일의 상단에 작성

### 세부 내용

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org/DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- JDBC Driver 클래스와 데이터베이스 연결 설정 -->
    <!-- 이 연결 설정에 대한 내용은 XML 안에 직접 작성하지 않는다.
         별도의 외부파일에 작성해서 해당 파일을 property로
         가져와서 사용한다.
    -->
    <properties resource="./driver.properties"/>

    <!-- MyBatis 실행 설정을 한다. -->
    <!-- 상당히 많은 설정이 있지만, 대부분 default 설정을 이용 -->
    <settings>
        <setting name="jdbcTypeForNull" value="NULL"/>
    </settings>

    <!-- TypeAlias가 나올 수 있다. -->
    <!-- 일반적으로 VO에 대한 alias가 설정된다. -->
    <typeAliases>
        <typeAlias alias="Book" type="example.vo.BookVO" />
    </typeAliases>

    <!-- DB 연결 정보 -->
    <environments default="development">
        <environment id="development">
            <!-- transactionManager를 JDBC로 설정하면
                 수동으로 transaction을 설정한다는 의미.
                 commit(), rollback()을 코드에서 제어 => JDBC
                 만약 type이 MANAGE로 설정하면 자동으로 transaction을
                 제어하게 할 수 있다.
            -->
            <transactionManager type="JDBC" />
            <!-- connetcion pool을 사용할지 여부를 설정 -->
            <dataSource type="POOLED" >
                <property name="driver" value="${db.driver}"/>
                <property name="url" value="${db.url}"/>
                <property name="username" value="${db.username}"/>
                <property name="password" value="${db.password}"/>
            </dataSource>
        </environment>
    </environments>

    <!-- SQL구문을 작성하는 mapper라는 xml 파일의 경로를 지정 -->
    <mappers>
        <mapper resource="./sqlmap/Book.xml"/>
    </mappers>

</configuration>
```

## mapper

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
        PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
```

→ Book.xml 파일 상단에 작성

### 세부 내용

```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org/DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="example.MyBook">
    <select id="selectByISBNHashMap" parameterType="String"
        resultType="HashMap">
        <![CDATA[
            SELECT bisbn, btitle, bprice, bauthor
            FROM book
            WHERE bisbn = #{bisbn}
        ]]>
    </select>

    <select id="selectAllHashMap"
            resultType="HashMap">
        <![CDATA[
        SELECT bisbn, btitle, bprice, bauthor
        FROM book
        ]]>
    </select>

    <select id="selectAllBookVO" parameterType="String"
            resultType="Book">
        <![CDATA[
        SELECT bisbn, btitle, bprice, bauthor
        FROM book
        WHERE bisbn = #{s}
        ]]>
    </select>

    <insert id="insertBook" parameterType="example.vo.BookVO">
        <![CDATA[
        INSERT INTO book (bisbn, btitle, bprice, bauthor)
        VALUES (#{bisbn}, #{btitle}, #{bprice}, #{bauthor})
        ]]>
    </insert>

    <select id="searchBooksByTitle" parameterType="String" resultType="example.vo.BookVO">
     <![CDATA[
        SELECT bisbn, btitle, bprice, bauthor FROM book WHERE btitle LIKE '%' || #{title} || '%'
        ]]>
    </select>

    <delete id="deleteBookByISBN" parameterType="String">
    <![CDATA[
        DELETE FROM book WHERE bisbn = #{isbn}
        ]]>
    </delete>

</mapper>
```

## Session Factory

```java
package example.mybatis;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.Reader;

// 결국 이 Java class가 하는 일은
// SqlSessionFactory이라는 객체가 우리 DAO에서 필요하기 때문에
// 이 객체를 통해서 우리는 SqlSession 객체를 뽑아낼 수 있다.
// 그리고 이 SqlSession 객체를 이용해야지만 우리가 SQL문을 실행할 수 있다.

public class MyBatisSessionFactory {
    private static SqlSessionFactory sqlSessionFactory;

    static {
        try {
            String resource = "./SqlMapConfig.xml";
            Reader reader = Resources.getResourceAsReader(resource);

            if (sqlSessionFactory == null) {
                sqlSessionFactory =
                        new SqlSessionFactoryBuilder().build(reader);
            }
        } catch(Exception e) {
            e.printStackTrace();
        }
    }

    public static SqlSessionFactory getSqlSessionFactory() {
        return sqlSessionFactory;
    }
}

```
